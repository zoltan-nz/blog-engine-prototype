[tools]
hey = "latest"
node = "latest"
pnpm = "latest"
rust = "latest"

# =============================================================================
# Compose Tasks (Primary Workflow)
# =============================================================================

[tasks.up]
description = "Start all services (both backends + svelte) for comparison"
run = "podman compose --profile rust --profile node --profile svelte --profile react up --remove-orphans"

[tasks.up-d]
description = "Start all services detached"
run = "podman compose --profile rust --profile node --profile svelte up -d"

[tasks.up-rust]
description = "Start stack with Rust backend only"
run = "podman compose --profile rust up"

[tasks.up-node]
description = "Start stack with Node backend only"
run = "podman compose --profile node up"

[tasks.up-svelte]
description = "Start SvelteKit + Rust backend (sweet spot combo)"
run = "podman compose --profile rust --profile svelte up"

[tasks.up-react]
description = "Start React + Node backend"
run = "podman compose --profile node --profile react up"

[tasks.down]
description = "Stop and remove compose stack"
run = "podman compose down"

[tasks.logs]
description = "Follow compose logs"
run = "podman compose logs -f"

# =============================================================================
# Integration Tests (Playwright - runs outside compose)
# =============================================================================

[tasks.test-svelte-rust]
description = "E2E test: Svelte + Rust (sweet spot)"
run = "FRONTEND_URL=http://localhost:3000 BACKEND_URL=http://localhost:8080 pnpm exec playwright test"
dir = "integration-tests"

[tasks.test-svelte-node]
description = "E2E test: Svelte + Node"
run = "FRONTEND_URL=http://localhost:3000 BACKEND_URL=http://localhost:8081 pnpm exec playwright test"
dir = "integration-tests"

[tasks.test-react-rust]
description = "E2E test: React + Rust"
run = "FRONTEND_URL=http://localhost:3001 BACKEND_URL=http://localhost:8080 pnpm exec playwright test"
dir = "integration-tests"

[tasks.test-react-node]
description = "E2E test: React + Node"
run = "FRONTEND_URL=http://localhost:3001 BACKEND_URL=http://localhost:8081 pnpm exec playwright test"
dir = "integration-tests"

[tasks.test-all-combos]
description = "E2E test all 4 frontend/backend combinations"
depends = ["test-svelte-rust", "test-svelte-node", "test-react-rust", "test-react-node"]

# =============================================================================
# Unit Tests (run outside compose, watch mode)
# =============================================================================

[tasks.test-unit-rust]
description = "Run Rust backend unit tests in watch mode"
run = "cd admin-cms-app/backend-rust && cargo watch -x test"

[tasks.test-unit-node]
description = "Run Node backend unit tests in watch mode"
run = "cd admin-cms-app/backend-node && pnpm exec vitest --watch"

[tasks.test-unit-svelte]
description = "Run SvelteKit frontend unit tests in watch mode"
run = "cd admin-cms-app/frontend-svelte && pnpm exec vitest --watch"

[tasks.test-unit-react]
description = "Run React frontend unit tests in watch mode"
run = "cd admin-cms-app/frontend-react && pnpm exec vitest --watch"

[tasks.test-unit]
description = "Run all unit tests (parallel, not watch mode)"
run = """
echo "=== Running all unit tests ===" && \
(cd admin-cms-app/backend-rust && cargo test) && \
(cd admin-cms-app/backend-node && pnpm exec vitest run) && \
(cd admin-cms-app/frontend-svelte && pnpm exec vitest run) && \
(cd admin-cms-app/frontend-react && pnpm exec vitest run) && \
echo "=== All unit tests passed ==="
"""

# =============================================================================
# Health Check Tasks
# =============================================================================

[tasks.health-rust]
description = "Check Rust backend health (port 8080)"
run = "curl -s http://127.0.0.1:8080/healthz | jq ."

[tasks.health-node]
description = "Check Node backend health (port 8081)"
run = "curl -s http://127.0.0.1:8081/healthz | jq ."

[tasks.health-svelte]
description = "Check SvelteKit frontend (port 3000)"
run = "curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:3000 && echo ' OK'"

[tasks.health]
description = "Check all health endpoints"
depends = ["health-rust", "health-node", "health-svelte"]

# =============================================================================
# Container Stats
# =============================================================================

[tasks.stats]
description = "Show container resource usage"
run = """
echo "=== Image Sizes ===" && podman image ls --format "table {% raw %}{{.Repository}}\t{{.Size}}{% endraw %}" | grep -E "(backend|frontend|REPOSITORY)" && echo "" && echo "=== Memory Usage ===" && podman stats --no-stream --format "table {% raw %}{{.Name}}\t{{.MemUsage}}{% endraw %}" 2>/dev/null || echo "No running containers"
"""

# =============================================================================
# Production Compose Stack
# =============================================================================

[tasks.prod-up]
description = "Start production stack (all services)"
run = "podman compose -f compose.prod.yaml --profile rust --profile node --profile svelte --profile react up --build"

[tasks.prod-down]
description = "Stop production stack"
run = "podman compose -f compose.prod.yaml --profile rust --profile node --profile svelte --profile react down"
