name: blog-engine

networks:
  blog-net:
    driver: bridge

volumes:
  astro-sites:

services:
  astro-server:
    build:
      context: ./astro-server
      dockerfile: Dockerfile
    networks:
      - blog-net
    volumes:
      - astro-sites:/app/astro-sites
    healthcheck:
      test: ['CMD', 'node', '-e', "console.log('ok')"]
      interval: 10s
      timeout: 5s
      retries: 3
    ports:
      - '4321:4321'

  backend-rust:
    profiles: [rust]
    build:
      context: ./admin-cms-app/backend-rust
      dockerfile: Dockerfile.dev
    networks:
      - blog-net
    ports:
      - '8080:8080'
    healthcheck:
      test: ['CMD-SHELL', 'curl -sf http://127.0.0.1:8080/healthz || exit 1']
      interval: 10s
      timeout: 5s
      retries: 3

  backend-node:
    profiles: [node]
    build:
      context: ./admin-cms-app/backend-node
      dockerfile: Dockerfile.dev
    networks:
      - blog-net
    ports:
      - '8081:8080'
    volumes:
      - ./admin-cms-app/backend-node/:/app/:ro
      - /app/node_modules
    environment:
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=100
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://127.0.0.1:8081/healthz']
      interval: 10s
      timeout: 5s
      retries: 3

  frontend-svelte:
    profiles: [svelte]
    build:
      context: ./admin-cms-app/frontend-svelte
      dockerfile: Dockerfile.dev
    networks:
      - blog-net
    ports:
      - '3000:3000'
    environment:
      # Use the Rust server as backend for Svelte.
      - PUBLIC_API_BACKEND_URL=http://localhost:8080
    volumes:
      - ./admin-cms-app/frontend-svelte/src:/app/src:ro
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://127.0.0.1:3000']
      interval: 10s
      timeout: 5s
      retries: 3

  frontend-react:
    profiles: [react]
    build:
      context: ./admin-cms-app/frontend-react
      dockerfile: Dockerfile.dev
    networks:
      - blog-net
    ports:
      - '3001:3001'
    environment:
      # Let's use the Node.js server as backend for React.
      - VITE_API_BACKEND_URL=http://localhost:8081
      - CHOKIDAR_USEPOLLING=true
      - CHOKIDAR_INTERVAL=100
    volumes:
      - ./admin-cms-app/frontend-react/:/app/:ro
      - /app/node_modules
      - /app/.react-router
    healthcheck:
      test: ['CMD', 'wget', '-q', '--spider', 'http://127.0.0.1:3001']
      interval: 10s
      timeout: 5s
      retries: 3
